# Plan implementacji widoku Pokoje (lista, szczegóły, edytor)

## 1. Przegląd
Widoki pokojów obejmują: dashboard z listą pokojów, szczegóły pokoju z siatką i listą mebli oraz edytor tworzenia/edycji pokoju z rysowaniem siatki. Celem jest pełny przepływ zarządzania pokojami zgodny z PRD (tworzenie, edycja, usuwanie) oraz czytelne UX (puste stany, błędy w toastach, dostępne akcje).

## 2. Routing widoku
- `/rooms` — Lista pokojów (Dashboard).
- `/rooms/new` — Edytor tworzenia pokoju.
- `/rooms/:roomId` — Szczegóły pokoju.
- `/rooms/:roomId/edit` — Edytor edycji pokoju.

## 3. Struktura komponentów
- RoomsListPage
  - RoomsListHeader
  - RoomsList
    - RoomCard (xN)
  - EmptyState
- RoomDetailsPage
  - RoomHeader
  - RoomGridPreview
  - FurnitureList
    - FurnitureListItem (xN)
  - EmptyState (brak mebli)
- RoomEditorPage
  - RoomForm
    - RoomNameField
    - RoomColorPicker
  - RoomGridEditor
    - RoomGridCell (xN)
  - RoomEditorActions
- Shared
  - ConfirmDialog
  - ErrorToast
  - LoadingState

## 4. Szczegóły komponentów

### RoomsListPage
- Opis komponentu: Kontener strony listy pokojów. Ładuje dane, obsługuje błąd, renderuje listę, empty state i CTA.
- Główne elementy: `section`, nagłówek z `button` „Dodaj pokój”, lista kart, loader, empty state.
- Obsługiwane interakcje: inicjalne ładowanie, klik „Dodaj pokój”, klik „Edytuj”, klik „Usuń” (z potwierdzeniem).
- Obsługiwana walidacja: brak lokalnych walidacji poza filtrem nazwy (jeśli dodany w przyszłości).
- Typy: `RoomDto`, `RoomListItemVM`, `RoomsListState`.
- Propsy: brak (routing page).

### RoomsListHeader
- Opis komponentu: Pasek nagłówka listy z tytułem i CTA „Dodaj pokój”.
- Główne elementy: `h1`, `button`.
- Obsługiwane interakcje: `click` CTA.
- Obsługiwana walidacja: brak.
- Typy: brak.
- Propsy: `onCreate: () => void`.

### RoomsList
- Opis komponentu: Lista kart/wierszy pokojów.
- Główne elementy: `ul`/`div` z `RoomCard`.
- Obsługiwane interakcje: przekazanie zdarzeń „Edytuj”, „Usuń”, „Otwórz”.
- Obsługiwana walidacja: brak.
- Typy: `RoomListItemVM`.
- Propsy: `rooms: RoomListItemVM[]`, `onOpen(id)`, `onEdit(id)`, `onDelete(id)`.

### RoomCard
- Opis komponentu: Wizualna karta pokoju (nazwa, kolor, akcje).
- Główne elementy: `mat-card`, wskaźnik koloru, `button` „Edytuj”, `button` „Usuń”.
- Obsługiwane interakcje: `click` na kartę (przejście do szczegółów), `click` na akcje.
- Obsługiwana walidacja: brak.
- Typy: `RoomListItemVM`.
- Propsy: `room: RoomListItemVM`, `onOpen`, `onEdit`, `onDelete`.

### RoomDetailsPage
- Opis komponentu: Widok szczegółów pokoju; pokazuje siatkę i listę mebli.
- Główne elementy: nagłówek z nazwą i kolorem, `RoomGridPreview`, `FurnitureList`, CTA „Dodaj mebel”.
- Obsługiwane interakcje: inicjalne ładowanie pokoju, klik mebla (otwarcie modala), klik „Dodaj mebel”.
- Obsługiwana walidacja: brak lokalnych walidacji.
- Typy: `RoomDto`, `RoomDetailsVM`, `FurnitureListItemVM` (do czasu API mebli można użyć placeholdera).
- Propsy: brak (routing page).

### RoomGridPreview
- Opis komponentu: Prezentacja siatki pokoju (bez edycji).
- Główne elementy: `div` z CSS Grid lub `canvas`.
- Obsługiwane interakcje: brak.
- Obsługiwana walidacja: spójność wymiarów siatki z `width_cells`, `height_cells`, `cell_size_m`.
- Typy: `RoomGridVM`.
- Propsy: `grid: RoomGridVM`.

### FurnitureList
- Opis komponentu: Lista mebli w pokoju.
- Główne elementy: `ul`/`mat-list` z `FurnitureListItem`.
- Obsługiwane interakcje: `click` elementu.
- Obsługiwana walidacja: brak.
- Typy: `FurnitureListItemVM`.
- Propsy: `items: FurnitureListItemVM[]`, `highlightedId?: UUID`, `onSelect(id)`.

### RoomEditorPage
- Opis komponentu: Kontener tworzenia/edycji pokoju; zarządza formularzem, siatką i zapisem.
- Główne elementy: `RoomForm`, `RoomGridEditor`, przyciski „Zapisz” i „Anuluj”.
- Obsługiwane interakcje: zapisz/anuluj, edycja pól, malowanie siatki.
- Obsługiwana walidacja: walidacja pól formularza i reguł siatki przed zapisem.
- Typy: `RoomFormVM`, `RoomGridVM`, `RoomEditorState`.
- Propsy: brak (routing page).

### RoomForm
- Opis komponentu: Formularz metadanych pokoju (nazwa, kolor).
- Główne elementy: `mat-form-field` z `input`, komponent palety kolorów.
- Obsługiwane interakcje: `input`, `change`.
- Obsługiwana walidacja: `name` wymagane, max 100 znaków w UI (API do 120), `color` hex `#RRGGBB`.
- Typy: `RoomFormVM`.
- Propsy: `value: RoomFormVM`, `onChange(value)`.

### RoomColorPicker
- Opis komponentu: Paleta do 20 kolorów + opcjonalne pole HEX.
- Główne elementy: siatka przycisków kolorów, opcjonalny `input` HEX.
- Obsługiwane interakcje: `click` na kolor, `input` HEX.
- Obsługiwana walidacja: hex `#RRGGBB`.
- Typy: `ColorOption`.
- Propsy: `colors: ColorOption[]`, `value: string`, `onChange(color)`.

### RoomGridEditor
- Opis komponentu: Edytor siatki do 40x40 z możliwością malowania i kasowania pól.
- Główne elementy: `div` z CSS Grid, `RoomGridCell`.
- Obsługiwane interakcje: `click` komórki, `drag` (opcjonalnie), `clear selection`.
- Obsługiwana walidacja: komórki muszą się stykać (nowe pole tylko obok istniejącego), maks. 40x40 w UI, `cell_size_m` = 0.5.
- Typy: `RoomGridVM`, `RoomGridCellVM`.
- Propsy: `grid: RoomGridVM`, `onToggleCell(cell)`.

### RoomEditorActions
- Opis komponentu: Przyciski akcji edytora.
- Główne elementy: `button` „Zapisz”, `button` „Anuluj”.
- Obsługiwane interakcje: `click` save/cancel.
- Obsługiwana walidacja: blokada „Zapisz” jeśli formularz/siatka niepoprawna.
- Typy: brak.
- Propsy: `canSave: boolean`, `onSave()`, `onCancel()`.

### ConfirmDialog
- Opis komponentu: Potwierdzenie usunięcia pokoju.
- Główne elementy: `mat-dialog` z treścią i przyciskami.
- Obsługiwane interakcje: `confirm`, `cancel`.
- Obsługiwana walidacja: brak.
- Typy: `ConfirmDialogData`.
- Propsy: `data: ConfirmDialogData`.

## 5. Typy
- `RoomDto` (z `rooms.types.ts`): `id`, `name`, `color`, `x_start`, `y_start`, `width_cells`, `height_cells`, `cell_size_m`, `created_at`, `updated_at`.
- `RoomListItemVM`: `{ id: UUID; name: string; color: string; updatedAt: string }`.
- `RoomsListState`: `{ rooms: RoomListItemVM[]; isLoading: boolean; error?: ApiError }`.
- `RoomFormVM`: `{ name: string; color: string }`.
- `RoomGridCellVM`: `{ x: number; y: number; filled: boolean }`.
- `RoomGridVM`: `{ width: number; height: number; cellSizeM: number; filledCells: Set<string> }` (klucz np. "x:y").
- `RoomEditorState`: `{ form: RoomFormVM; grid: RoomGridVM; isDirty: boolean; isSaving: boolean; error?: ApiError }`.
- `RoomDetailsVM`: `{ room: RoomDto; grid: RoomGridVM; furniture: FurnitureListItemVM[] }`.
- `FurnitureListItemVM`: `{ id: UUID; name: string; color: string }` (placeholder do czasu API mebli).
- `ColorOption`: `{ value: string; label?: string }`.

## 6. Zarządzanie stanem
- Dla każdej strony komponentowej lokalny stan komponentu + RxJS (np. `BehaviorSubject`) do `isLoading`, `error`, `data`.
- `RoomsListPage`:
  - `rooms$`, `isLoading$`, `error$`.
  - metody `loadRooms()`, `deleteRoom(id)`.
- `RoomDetailsPage`:
  - `room$`, `grid$`, `furniture$`, `highlightedFurnitureId` z query param.
- `RoomEditorPage`:
  - `formState`, `gridState`, `isDirty`, `canSave`.
  - logika edycji siatki w dedykowanym serwisie `RoomGridEditorService` (np. sprawdzanie stykania się komórek).
- Custom „hook” w Angularze jako serwis: `RoomGridEditorService` (build/validate/toggle cells) + ewentualnie `RoomsFacadeService` (API + mapowanie do VM).

## 7. Integracja API
- Użyj `RoomsApi` z `frontend/src/app/rooms/rooms.api.ts`.
- Lista pokojów:
  - `RoomsApi.listRooms({ orderBy: 'created_at', orderDirection: 'desc', limit, offset })`.
  - Response: `RoomDto[]`.
- Pobranie pokoju:
  - `RoomsApi.getRoom(roomId)`.
  - Response: `RoomDto | null` (null -> 404/empty state).
- Utworzenie pokoju:
  - `RoomsApi.createRoom({ name, color, x_start, y_start, width_cells, height_cells, cell_size_m })`.
  - Response: `RoomDto`.
- Aktualizacja pokoju:
  - `RoomsApi.updateRoom(roomId, { name, color, x_start, y_start, width_cells, height_cells, cell_size_m })`.
  - Response: `RoomDto`.
- Usunięcie pokoju:
  - `RoomsApi.deleteRoom(roomId)`.
- Błędy mapowane przez `rooms.errors.ts`, wyświetlane w toast (zgodnie z PRD).

## 8. Interakcje użytkownika
- Lista pokojów:
  - Klik „Dodaj pokój” -> przejście do `/rooms/new`.
  - Klik na kartę -> przejście do `/rooms/:roomId`.
  - Klik „Edytuj” -> `/rooms/:roomId/edit`.
  - Klik „Usuń” -> dialog potwierdzenia, po potwierdzeniu usunięcie z listy (optymistycznie) i toast.
- Szczegóły pokoju:
  - Widok siatki + lista mebli.
  - Klik mebla -> otwarcie modala (do wdrożenia w osobnym zadaniu), mebel z wyszukania podświetlany na czerwono.
- Edytor pokoju:
  - Wpisanie nazwy i wybór koloru.
  - Malowanie siatki poprzez kliknięcia (i opcjonalnie przeciąganie).
  - „Zapisz” -> walidacja i wysłanie do API.
  - „Anuluj” -> powrót bez zapisu (zmiany przepadają).

## 9. Warunki i walidacja
- Nazwa pokoju:
  - Wymagana, unikalna (API zwraca konflikt), max 100 znaków w UI (API akceptuje do 120).
- Kolor:
  - HEX `#RRGGBB` (frontend walidacja regexem).
- Siatka:
  - `cell_size_m` zawsze 0.5.
  - `width_cells` i `height_cells` w UI max 40 (API dopuszcza 50).
  - `x_start`, `y_start` >= 0.
  - Pola siatki muszą się stykać; kliknięcie pola usuwa zaznaczenie.
- Update:
  - Co najmniej jedno pole zmienione przed zapisem.
- Lista:
  - `limit` 1–200, `offset` >= 0 tylko z `limit`.

## 10. Obsługa błędów
- Błędy API (`401`, `409`, `422`, `400`) mapowane na `ApiError` i prezentowane jako toast w prawym górnym rogu.
- Błąd konfliktu nazwy -> komunikat przy polu nazwy + toast.
- Błąd walidacji siatki -> inline komunikat (np. „Komórki muszą się stykać”).
- Pusty wynik `getRoom` -> ekran „Nie znaleziono pokoju” + CTA powrotu.
- Brak połączenia sieciowego -> toast i możliwość ponowienia.

## 11. Kroki implementacji
1. Zdefiniować routing dla `/rooms`, `/rooms/new`, `/rooms/:roomId`, `/rooms/:roomId/edit`.
2. Stworzyć `RoomsListPage` z integracją `RoomsApi.listRooms`, loadingiem i empty state.
3. Dodać `RoomCard` oraz `ConfirmDialog` dla usuwania z integracją `RoomsApi.deleteRoom`.
4. Stworzyć `RoomDetailsPage` z `RoomsApi.getRoom`, renderem `RoomGridPreview` i placeholderem listy mebli.
5. Dodać obsługę `highlightedFurnitureId` z query param oraz podświetlenie elementu.
6. Zaimplementować `RoomEditorPage` z `RoomForm`, `RoomColorPicker` i `RoomGridEditor`.
7. Dodać `RoomGridEditorService` do logiki malowania i reguły „komórki muszą się stykać”.
8. Zaimplementować walidację formularza i blokadę „Zapisz” przy błędach.
9. Zintegrować `RoomsApi.createRoom` dla `/rooms/new` i `RoomsApi.updateRoom` dla `/rooms/:roomId/edit`.
10. Dodać toasty błędów/ sukcesu (MatSnackBar) i komunikaty inline.
11. Sprawdzić dostępność: aria-labels dla przycisków, focus states, czytelne kontrasty.
12. Dodać testy jednostkowe komponentów (przynajmniej edytor i lista) zgodnie z `*.spec.ts` obok kodu.
