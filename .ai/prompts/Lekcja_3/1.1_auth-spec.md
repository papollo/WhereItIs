# Specyfikacja architektury autentykacji (US-001, US-002)

## Założenia i zgodność
- Stack: Angular 21 + Angular Material + RxJS + Supabase.
- Zakres: rejestracja, logowanie, wylogowanie, odzyskiwanie hasła.
- Dane użytkownika są izolowane przez RLS w Supabase (zgodnie z `db_schema.md`).
- Zmiany nie naruszają istniejących funkcjonalności zarządzania pokojami/meblami/przedmiotami.

## 1. ARCHITEKTURA INTERFEJSU UZYTKOWNIKA

### 1.1. Widoki, layouty i routing
- Wydzielone dwa layouty:
  - **AuthLayout**: lekki layout bez głównej nawigacji, przeznaczony dla ekranów logowania i rejestracji.
  - **AppLayout**: istniejący shell aplikacji (nawigacja + treść) dla użytkownika zalogowanego.
- Nowe trasy (propozycja):
  - `/login` -> `LoginPageComponent`
  - `/register` -> `RegisterPageComponent`
  - `/forgot-password` -> `ForgotPasswordPageComponent`
  - `/reset-password` -> `ResetPasswordPageComponent` (obsługa linku z emaila)
- Ochrona tras:
  - `AuthGuard` blokuje wejście do aplikacji bez sesji (np. `/rooms`, `/furniture`, `/items`).
  - `GuestGuard` blokuje dostęp do stron auth dla zalogowanych (przekierowanie do widoku głównego).
- Inicjalizacja sesji:
  - podczas startu aplikacji `AuthService` odczytuje sesję Supabase i publikuje stan do UI.
  - do czasu sprawdzenia sesji renderowany jest prosty stan „loading” w `AppComponent`.

### 1.2. Komponenty i moduły frontendu
- `AuthModule` (lazy-load):
  - `LoginPageComponent` – formularz email + hasło + link do resetu hasła.
  - `RegisterPageComponent` – formularz email + hasło + powtórzenie hasła.
  - `ForgotPasswordPageComponent` – formularz email.
  - `ResetPasswordPageComponent` – formularz nowego hasła + potwierdzenie.
- `SharedModule` (lub istniejący `shared/`):
  - `AuthFormCardComponent` – wspólna ramka z tytułem i akcją główną.
  - `PasswordFieldComponent` – pole hasła z „pokaż/ukryj”.
  - `InlineErrorComponent` – spójne komunikaty walidacyjne.
- Integracja z Angular Material:
  - `MatFormField`, `MatInput`, `MatButton`, `MatSnackBar` (toast w prawym górnym rogu).

### 1.3. Walidacje i komunikaty
- Walidacje po stronie UI (Reactive Forms):
  - `email`: wymagany, poprawny format.
  - `password`: wymagane, min. 8 znaków, przynajmniej 1 cyfra i 1 litera (reguła możliwa do złagodzenia, jeśli UX tego wymaga).
  - `confirmPassword`: zgodność z `password` (rejestracja/reset).
- Przykładowe komunikaty:
  - „Podaj poprawny adres email.”
  - „Hasło musi mieć co najmniej 8 znaków.”
  - „Hasła nie są takie same.”
  - „Niepoprawny email lub hasło.”
  - „Użytkownik o tym emailu już istnieje.”
- Błędy z Supabase mapowane na czytelne treści i wyświetlane w toastach (zgodnie z US-013).

### 1.4. Kluczowe scenariusze
- **Rejestracja**: wypełnienie formularza -> Supabase `signUp` -> sukces -> przekierowanie do `/login` i informacja o sukcesie.
- **Logowanie**: formularz -> Supabase `signInWithPassword` -> sukces -> przekierowanie do widoku głównego.
- **Wylogowanie**: kliknięcie „Wyloguj” w AppLayout -> `signOut` -> przekierowanie do `/login`.
- **Odzyskiwanie hasła**:
  - `/forgot-password`: email -> `resetPasswordForEmail` -> informacja o wysłaniu linku.
  - `/reset-password`: nowe hasło -> `updateUser` -> przekierowanie do `/login`.

## 2. LOGIKA BACKENDOWA

### 2.1. Kontrakty i endpointy
- Autentykacja realizowana przez Supabase Auth (wbudowane endpointy):
  - `POST /auth/v1/signup` – rejestracja.
  - `POST /auth/v1/token?grant_type=password` – logowanie.
  - `POST /auth/v1/recover` – wysłanie linku resetu hasła.
  - `PUT /auth/v1/user` – ustawienie nowego hasła po resecie.
  - `POST /auth/v1/logout` – wylogowanie.
- Dane domenowe (pokoje/meble/przedmioty) nadal przez PostgREST Supabase z RLS.

### 2.2. Modele danych
- Autentykacja oparta o `auth.users` (Supabase).
- Powiązanie danych aplikacji przez `user_id` (zgodnie z `db_schema.md`).
- Tabela `onboarding` powiązana z `auth.users` przygotowana pod US-003 (bez wpływu na bieżące funkcje auth).

### 2.3. Walidacja danych wejściowych
- Walidacja po stronie klienta (UI) + walidacja server-side w Supabase:
  - unikalność emaila egzekwowana przez Supabase Auth.
  - RLS zabezpiecza dostęp do danych domenowych (tylko `auth.uid()`).

### 2.4. Obsługa wyjątków
- Błędy Auth zwracane z Supabase mapowane do kodów i treści dla UI.
- Błędy systemowe (sieć, 5xx) -> globalny toast „Wystąpił błąd serwera. Spróbuj ponownie.”
- Brak ujawniania szczegółów błędów bezpieczeństwa w UI.

### 2.5. Renderowanie w zależności od stanu autentykacji
- `AuthGuard` kontroluje dostęp do tras aplikacji.
- `GuestGuard` blokuje widoki auth po zalogowaniu.
- UI przełącza layout (AuthLayout vs AppLayout) na podstawie stanu sesji.

## 3. SYSTEM AUTENTYKACJI (SUPABASE + ANGULAR)

### 3.1. Integracja klienta Supabase
- `SupabaseClient` inicjalizowany w `AuthService` (np. w `core/`):
  - klucze `SUPABASE_URL` i `SUPABASE_ANON_KEY` z `environment.ts`.
  - przechowywanie sesji w localStorage (domyślne zachowanie Supabase).

### 3.2. Serwisy i kontrakty frontendu
- `AuthService`:
  - `signUp(email, password)`
  - `signIn(email, password)`
  - `signOut()`
  - `requestPasswordReset(email)`
  - `resetPassword(newPassword)`
  - `getSession()` / `getUser()`
- `AuthStateService` (lub BehaviorSubject w `AuthService`):
  - emituje `isAuthenticated`, `user`, `loading`.
- `AuthGuard` / `GuestGuard`:
  - oparte o `AuthStateService`.
- `NotificationService`:
  - spójne toasty z błędami/komunikatami (prawy górny róg).

### 3.3. Bezpieczeństwo i zgodność
- RLS w Supabase wymusza izolację danych per `auth.uid()`.
- Hasła obsługiwane wyłącznie przez Supabase Auth (hash + przechowywanie zgodne z wymaganiami).
- Brak przechowywania wrażliwych danych w aplikacji poza sesją Supabase.

### 3.4. Przekierowania i konfiguracja resetu hasła
- Link resetu hasła kieruje na `/reset-password` w aplikacji.
- Po zmianie hasła użytkownik jest przekierowany do `/login`.

## 4. Wnioski kluczowe
- Autoryzacja jest realizowana przez Supabase Auth, a dostęp do danych domenowych chroni RLS.
- Frontend wprowadza osobny layout i moduł auth z pełnym zestawem formularzy.
- UX obejmuje wyraźne walidacje, spójne komunikaty błędów i kontrolę dostępu przez guardy.
- Architektura pozostaje zgodna z istniejącymi wymaganiami dotyczącymi pokojów, mebli i przedmiotów.
